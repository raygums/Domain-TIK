name: Sync to Bitbucket

on:
  push:
    branches:
      - '*'
    tags:
      - '*'
  delete:
  workflow_dispatch:

jobs:
  sync-to-bitbucket:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # WAJIB: Mengambil seluruh history

      - name: Setup SSH for Bitbucket
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.BITBUCKET_SSH_KEY }}

      - name: Sync to Bitbucket
        env:
          TARGET_REPO: git@bitbucket.org:mahendraunila/si-project-tik.git
        run: |
          # 1. Konfigurasi Git User
          git config --global user.email "bot@github.com"
          git config --global user.name "GitHub Sync Bot"
          
          # 2. Tambahkan Remote Bitbucket
          git remote add bitbucket $TARGET_REPO
          
          # 3. Setup Keamanan Host Key
          mkdir -p ~/.ssh
          ssh-keyscan bitbucket.org >> ~/.ssh/known_hosts
          
          # ========================================================
          # 4. UPDATE LOCAL REFERENCES (INI YANG SEBELUMNYA KURANG)
          # ========================================================
          # Perintah ini memaksa semua branch lokal di runner menjadi
          # sama persis dengan kondisi terbaru di GitHub (Origin).
          echo "Updating local branches from origin..."
          git fetch origin "+refs/heads/*:refs/heads/*" --update-head-ok
          
          # 5. Eksekusi Sinkronisasi ke Bitbucket
          echo "Pushing changes to Bitbucket..."
          
          # Push semua branch (--all) dengan force
          git push bitbucket --all --force
          
          # Push semua tags
          git push bitbucket --tags --force
          
          # Hapus branch di Bitbucket yang sudah dihapus di GitHub (--prune)
          # Note: --prune tidak bisa digabung dengan --all di beberapa versi git,
          # jadi kita jalankan terpisah untuk memastikan.
          git fetch bitbucket
          git remote prune bitbucket
